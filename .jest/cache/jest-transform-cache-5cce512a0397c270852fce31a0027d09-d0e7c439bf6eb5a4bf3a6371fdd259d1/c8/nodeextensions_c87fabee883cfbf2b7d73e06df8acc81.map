{"version":3,"sources":["node-extensions.js"],"names":["Promise","require","asap","module","exports","denodeify","fn","argumentCount","Infinity","denodeifyWithCount","denodeifyWithoutCount","callbackFn","args","i","push","body","join","concat","Function","fnLength","Math","max","length","map","_","index","slice","nodeify","Array","prototype","call","arguments","callback","pop","ctx","apply","ex","resolve","reject","then","value","err"],"mappings":"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","sourcesContent":["'use strict';\n\n// This file contains then/promise specific extensions that are only useful\n// for node.js interop\n\nvar Promise = require('./core.js');\nvar asap = require('asap');\n\nmodule.exports = Promise;\n\n/* Static Functions */\n\nPromise.denodeify = function (fn, argumentCount) {\n  if (\n    typeof argumentCount === 'number' && argumentCount !== Infinity\n  ) {\n    return denodeifyWithCount(fn, argumentCount);\n  } else {\n    return denodeifyWithoutCount(fn);\n  }\n};\n\nvar callbackFn = (\n  'function (err, res) {' +\n  'if (err) { rj(err); } else { rs(res); }' +\n  '}'\n);\nfunction denodeifyWithCount(fn, argumentCount) {\n  var args = [];\n  for (var i = 0; i < argumentCount; i++) {\n    args.push('a' + i);\n  }\n  var body = [\n    'return function (' + args.join(',') + ') {',\n    'var self = this;',\n    'return new Promise(function (rs, rj) {',\n    'var res = fn.call(',\n    ['self'].concat(args).concat([callbackFn]).join(','),\n    ');',\n    'if (res &&',\n    '(typeof res === \"object\" || typeof res === \"function\") &&',\n    'typeof res.then === \"function\"',\n    ') {rs(res);}',\n    '});',\n    '};'\n  ].join('');\n  return Function(['Promise', 'fn'], body)(Promise, fn);\n}\nfunction denodeifyWithoutCount(fn) {\n  var fnLength = Math.max(fn.length - 1, 3);\n  var args = [];\n  for (var i = 0; i < fnLength; i++) {\n    args.push('a' + i);\n  }\n  var body = [\n    'return function (' + args.join(',') + ') {',\n    'var self = this;',\n    'var args;',\n    'var argLength = arguments.length;',\n    'if (arguments.length > ' + fnLength + ') {',\n    'args = new Array(arguments.length + 1);',\n    'for (var i = 0; i < arguments.length; i++) {',\n    'args[i] = arguments[i];',\n    '}',\n    '}',\n    'return new Promise(function (rs, rj) {',\n    'var cb = ' + callbackFn + ';',\n    'var res;',\n    'switch (argLength) {',\n    args.concat(['extra']).map(function (_, index) {\n      return (\n        'case ' + (index) + ':' +\n        'res = fn.call(' + ['self'].concat(args.slice(0, index)).concat('cb').join(',') + ');' +\n        'break;'\n      );\n    }).join(''),\n    'default:',\n    'args[argLength] = cb;',\n    'res = fn.apply(self, args);',\n    '}',\n    \n    'if (res &&',\n    '(typeof res === \"object\" || typeof res === \"function\") &&',\n    'typeof res.then === \"function\"',\n    ') {rs(res);}',\n    '});',\n    '};'\n  ].join('');\n\n  return Function(\n    ['Promise', 'fn'],\n    body\n  )(Promise, fn);\n}\n\nPromise.nodeify = function (fn) {\n  return function () {\n    var args = Array.prototype.slice.call(arguments);\n    var callback =\n      typeof args[args.length - 1] === 'function' ? args.pop() : null;\n    var ctx = this;\n    try {\n      return fn.apply(this, arguments).nodeify(callback, ctx);\n    } catch (ex) {\n      if (callback === null || typeof callback == 'undefined') {\n        return new Promise(function (resolve, reject) {\n          reject(ex);\n        });\n      } else {\n        asap(function () {\n          callback.call(ctx, ex);\n        })\n      }\n    }\n  }\n};\n\nPromise.prototype.nodeify = function (callback, ctx) {\n  if (typeof callback != 'function') return this;\n\n  this.then(function (value) {\n    asap(function () {\n      callback.call(ctx, null, value);\n    });\n  }, function (err) {\n    asap(function () {\n      callback.call(ctx, err);\n    });\n  });\n};\n"]}